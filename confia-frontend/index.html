<!DOCTYPE html>
<html lang="pt-BR" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hub Central - Portal de Notícias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <style>
        .side-open { transform: translateX(0) !important; }
        #user-profile-container { width: 100%; }
        #profile-modal { z-index: 60; }
        #ultimas-noticias-container:empty::before,
        #highlightCarousel:empty { /* Carrossel não deve mostrar 'carregando' */
            min-height: 200px; /* Apenas garante altura */
            background-color: #e5e7eb; /* bg-gray-200 */
        }
        html.dark #highlightCarousel:empty {
            background-color: #334155; /* dark:bg-slate-700 */
        }
        #ultimas-noticias-container:empty::before {
            content: 'Carregando...'; display: block; text-align: center; padding: 2rem; color: #6b7280;
        }
        html.dark #ultimas-noticias-container:empty::before { color: #9ca3af; }
    </style>
    <link rel="website icon" type="png" href="logo_confia.png">
</head>
<body class="bg-gray-100 dark:bg-slate-900 font-sans">

    <aside id="sidebar" class="transition-transform duration-300 ease-in-out flex flex-col bg-blue-300 dark:bg-gray-800 w-64 fixed inset-y-0 left-0 z-30 shadow-lg transform -translate-x-full lg:translate-x-0">
        <div class="flex items-center justify-center p-4 h-16 border-b dark:border-gray-700">
            <img src="logo_confia.png" width="145px" alt="Logo Confia!">
        </div>
        <nav class="flex-grow p-4 space-y-2 mt-4">
            <a href="index.html" class="flex items-center py-2.5 px-4 rounded-lg bg-blue-500 text-white font-semibold"><i class="fas fa-home w-6 mr-3"></i> Início</a>
            <a href="noticias.html" class="flex items-center py-2.5 px-4 rounded-lg text-white hover:bg-blue-600 dark:text-slate-300 dark:hover:bg-gray-700"><i class="fas fa-th-large w-6 mr-3"></i> Notícias</a>
            <a href="politica.html" class="flex items-center py-2.5 px-4 rounded-lg text-white hover:bg-blue-600 dark:text-slate-300 dark:hover:bg-gray-700"><i class="fas fa-landmark w-6 mr-3"></i> Política</a>
            <a href="editor.html" class="flex items-center py-2.5 px-4 rounded-lg text-white hover:bg-blue-600 dark:text-slate-300 dark:hover:bg-gray-700" style="display: none;"><i class="fas fa-pen-nib w-6 mr-3"></i> Editor</a>
            <a href="feedback.html" class="flex items-center py-2.5 px-4 rounded-lg text-white hover:bg-blue-600 dark:text-slate-300 dark:hover:bg-gray-700"><i class="fas fa-comment-alt w-6 mr-3"></i> Feedback</a>
            <a href="sobre-nos.html" class="flex items-center py-2.5 px-4 rounded-lg text-white hover:bg-blue-600 dark:text-slate-300 dark:hover:bg-gray-700"><i class="fas fa-users w-6 mr-3"></i> Sobre Nós</a>
            <a href="login.html" id="auth-link" class="flex items-center py-2.5 px-4 rounded-lg text-white hover:bg-blue-600 dark:text-slate-300 dark:hover:bg-gray-700 mt-6 border-t pt-4 dark:border-gray-700">
                <i class="fas fa-sign-in-alt w-6 mr-3"></i> Login
            </a>
        </nav>

        <div id="user-profile-container" class="mt-auto relative">
    <a href="login.html" id="user-profile" class="flex items-center space-x-3 p-4 bg-blue-400 dark:bg-gray-700 hover:bg-blue-500 dark:hover:bg-gray-600 transition cursor-pointer w-full">
        <img src="https://ui-avatars.com/api/?name=?&background=6b7280&color=fff&bold=true" alt="User Avatar" class="w-10 h-10 rounded-full">
        <span class="text-white font-medium block text-sm">Fazer Login</span>
    </a>

    <div id="profile-modal"
         class="absolute z-50 left-0 bottom-full mb-1 w-full bg-white dark:bg-gray-800 rounded-lg shadow-xl overflow-hidden transition-all duration-300 ease-out transform scale-95 opacity-0 hidden"
         role="dialog" aria-modal="true" style="min-width: 220px;">

        <a href="perfil.html" id="modal-profile-link" class="block p-3 border-b border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-t-lg">
             <div class="flex items-center space-x-3">
                 <img src="https://ui-avatars.com/api/?name=?&background=6b7280&color=fff&bold=true" alt="User Avatar Modal" class="w-10 h-10 rounded-full">
                 <div class="flex-grow min-w-0">
                     <p class="font-semibold text-md text-gray-900 dark:text-white truncate">Nome</p>
                     <p class="text-xs text-gray-500 dark:text-gray-300 truncate">email@exemplo.com</p>
                 </div>
            </div>
        </a>

        <nav class="p-2 space-y-1">
             <a href="perfil.html" id="modal-my-profile-link" class="flex items-center p-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-lg transition-colors">
                 <i class="fas fa-user w-5 mr-3 text-gray-500 dark:text-gray-400"></i> Meu Perfil
             </a>
             <div id="modal-logout-container" class="border-t border-gray-200 dark:border-gray-600 mt-1 pt-1">
                 {/* JS insere o botão "Sair" aqui */}
             </div>
         </nav>
    </div>
    </div>
    </aside>

    <div id="overlay" class="transition-opacity duration-300 ease-in-out fixed inset-0 bg-black/60 opacity-0 z-20 lg:hidden pointer-events-none"></div>

    <div class="lg:ml-64">
        <header class="bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm shadow-sm sticky top-0 z-10">
            <div class="container mx-auto px-4 py-3 h-16 flex justify-between items-center">
                <button id="menuToggle" class="text-gray-600 dark:text-gray-300 text-2xl lg:hidden"><i class="fas fa-bars"></i></button>
                <div class="relative w-full max-w-lg mx-4">
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="Pesquisar..." class="w-full py-2 px-4 pr-10 rounded-full bg-gray-100 dark:bg-slate-700 text-gray-800 dark:text-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="searchButton" class="absolute right-0 top-0 h-full px-3 text-gray-400 hover:text-blue-500"><i class="fas fa-search"></i></button>
                    </div>
                    <div id="searchDropdown" class="hidden absolute w-full z-20 mt-1 bg-white dark:bg-slate-700 rounded-lg shadow-lg overflow-hidden">
                        <div id="searchResults" class="max-h-60 overflow-y-auto"></div>
                    </div>
                </div>
                <button id="themeToggle" class="text-gray-600 dark:text-gray-300 text-xl p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition"><i class="fas fa-sun" id="theme-icon"></i></button>
            </div>
        </header>

        <main class="container mx-auto px-4 py-6">
            <section class="mb-8"><div class="bg-white dark:bg-slate-800 rounded-lg shadow-md p-6"><h2 class="text-2xl font-bold text-gray-800 dark:text-white">Bem-vindo!</h2><p class="text-gray-600 dark:text-gray-400">Últimas notícias personalizadas.</p></div></section>
            <section class="mb-10"><h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4 flex items-center"><i class="fas fa-star mr-2 text-yellow-400"></i> Destaques</h2><div class="relative overflow-hidden rounded-xl shadow-lg bg-gray-200 dark:bg-slate-700 min-h-[200px]"><div id="highlightCarousel" class="flex transition-transform duration-300"></div><button id="prevBtn" class="absolute left-4 top-1/2 transform -translate-y-1/2 bg-black/50 text-white p-2 rounded-full hover:bg-black/70 disabled:opacity-50" style="display: none;"><i class="fas fa-chevron-left"></i></button><button id="nextBtn" class="absolute right-4 top-1/2 transform -translate-y-1/2 bg-black/50 text-white p-2 rounded-full hover:bg-black/70 disabled:opacity-50" style="display: none;"><i class="fas fa-chevron-right"></i></button></div></section>
            
            <section class="mb-10">
                <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4 flex items-center">
                    <i class="fas fa-bolt mr-2 text-blue-500"></i> Acesso Rápido
                </h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                     <a href="politica.html" class="block p-4 bg-white dark:bg-slate-700 text-gray-800 dark:text-gray-200 rounded-lg shadow text-center hover:shadow-md transition dark:hover:bg-slate-600">Política</a>
                     <a href="noticias.html" class="block p-4 bg-white dark:bg-slate-700 text-gray-800 dark:text-gray-200 rounded-lg shadow text-center hover:shadow-md transition dark:hover:bg-slate-600">Economia</a>
                     <a href="noticias.html" class="block p-4 bg-white dark:bg-slate-700 text-gray-800 dark:text-gray-200 rounded-lg shadow text-center hover:shadow-md transition dark:hover:bg-slate-600">Tecnologia</a>
                     <a href="noticias.html" class="block p-4 bg-white dark:bg-slate-700 text-gray-800 dark:text-gray-200 rounded-lg shadow text-center hover:shadow-md transition dark:hover:bg-slate-600">Saúde</a>
                </div>
            </section>

            <div class="flex flex-col lg:flex-row gap-6">
                <section class="lg:w-2/3"><h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4 flex items-center"><i class="fas fa-clock mr-2 text-gray-500"></i> Últimas Notícias</h2><div id="ultimas-noticias-container" class="space-y-4"></div></section>
                <aside class="lg:w-1/3"><div class="bg-white dark:bg-slate-800 rounded-lg shadow-md p-4"><h3 class="font-bold mb-2 text-gray-800 dark:text-white">Populares</h3><ul class="text-sm space-y-1 text-gray-600 dark:text-gray-300"><li>#IA</li><li>#Eleições</li><li>#Mercado</li></ul></div></aside>
            </div>
        </main>

        <footer class="bg-gray-200 dark:bg-slate-800 text-gray-700 dark:text-gray-400 py-8 mt-12">
             <div id="footer-container" class="container mx-auto px-4">
                 <div id="footer-content" class="grid grid-cols-1 md:grid-cols-4 gap-8">
                      <div class="footer-section"> <h3 class="text-lg font-bold mb-2 text-gray-900 dark:text-white">Confia!</h3> <p class="text-sm">Sua fonte confiável...</p> </div>
                      <div class="footer-section"> <h4 class="font-bold mb-3 text-gray-900 dark:text-white">Categorias</h4> <ul class="space-y-1 text-sm"> <li><a href="politica.html" class="hover:text-blue-600 dark:hover:text-blue-400">Política</a></li> <li><a href="noticias.html" class="hover:text-blue-600 dark:hover:text-blue-400">Economia</a></li> <li><a href="noticias.html" class="hover:text-blue-600 dark:hover:text-blue-400">Tecnologia</a></li> </ul> </div>
                      <div class="footer-section"> <h4 class="font-bold mb-3 text-gray-900 dark:text-white">Links Úteis</h4> <ul class="space-y-1 text-sm"> <li><a href="sobre-nos.html" class="hover:text-blue-600 dark:hover:text-blue-400">Sobre</a></li> <li><a href="feedback.html" class="hover:text-blue-600 dark:hover:text-blue-400">Contato</a></li> <li><a href="#" class="hover:text-blue-600 dark:hover:text-blue-400">Termos</a></li> </ul> </div>
                      <div class="footer-section"> <h4 class="font-bold mb-3 text-gray-900 dark:text-white">Newsletter</h4> <p class="text-sm mb-2">Inscreva-se...</p> <div id="newsletter-form" class="flex"> <input type="email" placeholder="Seu e-mail" class="text-sm px-3 py-2 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-300 rounded-l-md w-full focus:outline-none"> <button class="bg-blue-600 hover:bg-blue-700 px-3 rounded-r-md text-white"><i class="fas fa-paper-plane text-sm"></i></button> </div> <div id="social-links" class="flex space-x-3 mt-4 text-gray-500 dark:text-gray-400"> <a href="#" class="hover:text-blue-600 dark:hover:text-blue-400 text-lg"><i class="fab fa-facebook"></i></a> <a href="#" class="hover:text-blue-600 dark:hover:text-blue-400 text-lg"><i class="fab fa-twitter"></i></a> <a href="#" class="hover:text-blue-600 dark:hover:text-blue-400 text-lg"><i class="fab fa-instagram"></i></a> </div> </div>
                 </div>
                 <div id="footer-bottom" class="border-t border-gray-300 dark:border-gray-700 mt-8 pt-6 text-center text-sm"><p>&copy; 2025 Confia!.</p></div>
             </div>
        </footer>
    </div>
    <script>
        // --- SELETORES GLOBAIS (Definidos no DOMContentLoaded) ---
        let menuToggle, sidebar, overlay, themeToggle, themeIcon, html,
            searchInput, searchButton, searchDropdown, searchResultsContainer,
            noticiasContainer, destaquesContainer, prevBtn, nextBtn, carousel,
            userProfileButton, profileModal, authLinkSidebar, editorLinkSidebar, modalLogoutContainer;

        // --- 1. LÓGICA DO MENU LATERAL ---
        let menuOpenIndex = false;
        function openMenuIndex() { if (!sidebar || !overlay) return; sidebar.classList.add('side-open'); overlay.classList.remove('pointer-events-none', 'opacity-0'); overlay.classList.add('opacity-100'); menuOpenIndex = true; }
        function closeMenuIndex() { if (!sidebar || !overlay) return; sidebar.classList.remove('side-open'); overlay.classList.add('pointer-events-none'); overlay.classList.remove('opacity-100'); overlay.classList.add('opacity-0'); menuOpenIndex = false; }

        // --- 2. LÓGICA DO TEMA ---
        function toggleThemeIndex() { if (!html || !themeIcon) return; const iD = html.classList.toggle('dark'); html.classList.toggle('light', !iD); if (iD) { themeIcon.classList.remove('fa-sun'); themeIcon.classList.add('fa-moon'); localStorage.setItem('theme', 'dark'); } else { themeIcon.classList.remove('fa-moon'); themeIcon.classList.add('fa-sun'); localStorage.setItem('theme', 'light'); } }
        function carregarTemaIndex() { if (!html || !themeIcon) { console.warn("Tema: HTML/Icon ausente."); return; } const p=localStorage.getItem('theme'), s=window.matchMedia('(prefers-color-scheme: dark)').matches, i=p||(s?'dark':'light'); html.classList.remove('light','dark'); html.classList.add(i); if(i==='dark'){themeIcon.classList.remove('fa-sun');themeIcon.classList.add('fa-moon');}else{themeIcon.classList.remove('fa-moon');themeIcon.classList.add('fa-sun');}}

        // --- 3. LÓGICA DO MODAL DE PERFIL ---
        function toggleProfileModalIndex(event) {
            if(event)event.preventDefault();
            // Seleciona de novo para garantir
            const cPB = document.getElementById('user-profile');
            const cPM = document.getElementById('profile-modal');
            if(!cPB||!cPM){console.warn("Modal: Botão/Modal ausente.");return;}
            const r=cPB.getBoundingClientRect();
            cPM.style.top='auto'; cPM.style.bottom=`${window.innerHeight-r.top-window.scrollY+5}px`;
            cPM.style.left=`${r.left+window.scrollX}px`; cPM.style.minWidth='220px';
            if(cPM.classList.contains('hidden')){cPM.classList.remove('hidden');void cPM.offsetWidth;cPM.classList.remove('opacity-0','scale-95');cPM.classList.add('opacity-100','scale-100');}
            else{cPM.classList.remove('opacity-100','scale-100');cPM.classList.add('opacity-0','scale-95');setTimeout(()=>{cPM.classList.add('hidden');},300);}
        }
       function handleClickOutsideModalIndex(event) {
            const cPB = document.getElementById('user-profile');
            const cPM = document.getElementById('profile-modal');
            if(!cPB||!cPM)return;
            if(!cPB.contains(event.target)&&!cPM.contains(event.target)&&!cPM.classList.contains('hidden')){
                cPM.classList.remove('opacity-100','scale-100');cPM.classList.add('opacity-0','scale-95');setTimeout(()=>{cPM.classList.add('hidden');},300);
            }
        }

        // --- 4. LÓGICA DE AUTENTICAÇÃO (CORRIGIDA) ---
       function verificarLoginIndex() {
            const token = localStorage.getItem('authToken'); let userInfo = null; const sUI = localStorage.getItem('userInfo');
            if(sUI){try{userInfo=JSON.parse(sUI);}catch(e){localStorage.clear();token=null;userInfo=null;}}
            
            const cPB = document.getElementById('user-profile'); 
            const cAL = document.getElementById('auth-link'); 
            const cEL = document.querySelector('nav a[href="editor.html"]'); 
            const cPM = document.getElementById('profile-modal');
            // Novos seletores para o modal
            const cMLC = cPM ? cPM.querySelector('#modal-logout-container') : null;
            const cMPL_Top = cPM ? cPM.querySelector('#modal-profile-link') : null; // Link do Topo do Modal
            const cMPL_Text = cPM ? cPM.querySelector('#modal-my-profile-link') : null; // Link "Meu Perfil"

            if(!cPB){console.error("CRÍTICO: #user-profile NÃO ENCONTRADO!"); return;}
            
            const nPB = cPB.cloneNode(true); // Clona para limpar listeners
            const uNS = nPB.querySelector('span'); // Pega span DO NOVO BOTÃO
            const uI = nPB.querySelector('img'); // Pega img DO NOVO BOTÃO
            if (cPB.parentNode) { cPB.parentNode.replaceChild(nPB, cPB); } else { console.error("Pai do #user-profile não encontrado"); }

            if (token && userInfo && userInfo.nome) { // --- LOGADO ---
                const uN=userInfo.nome, uE=userInfo.email||'', uID=userInfo.id||'';
                // Atualiza botão de perfil (rodapé)
                if(uNS)uNS.textContent=uN; 
                if(uI)uI.src=`https://ui-avatars.com/api/?name=${encodeURIComponent(uN)}&b=3b82f6&c=fff&bold=true`;
                nPB.href='#'; 
                nPB.addEventListener('click',toggleProfileModalIndex); // Adiciona listener para modal
                
                // Atualiza link da sidebar (nav)
                if(cAL){const nA=cAL.cloneNode(true); nA.href='#'; nA.innerHTML='<i class="fas fa-sign-out-alt w-6 mr-3"></i> Sair'; if(cAL.parentNode)cAL.parentNode.replaceChild(nA,cAL); nA.addEventListener('click',fazerLogoutIndex); authLinkSidebar = nA;}
                if(cEL)cEL.style.display='flex'; // Mostra Editor
                
                // Atualiza Modal
                if(cPM){
                     const mUN=cPM.querySelector('p.font-semibold'), mUE=cPM.querySelector('p.text-xs'), mUI=cPM.querySelector('img');
                     if(mUN)mUN.textContent=uN; if(mUE)mUE.textContent=uE; if(mUI)mUI.src=`https://ui-avatars.com/api/?name=${encodeURIComponent(uN)}&b=3b82f6&c=fff&bold=true`;
                     if(cMPL_Top) cMPL_Top.href = `perfil.html?id=${uID}`; // Link do topo
                     if(cMPL_Text) cMPL_Text.href = `perfil.html?id=${uID}`; // Link "Meu Perfil"
                     if(cMLC){cMLC.innerHTML=`<button id="logout-b-m-i" class="flex items-center p-2 text-sm w-full text-red-600 hover:bg-red-100 dark:text-red-400 dark:hover:bg-red-700/50 rounded-lg"><i class="fas fa-sign-out-alt w-5 mr-3"></i> Sair</button>`; const l=document.getElementById('logout-b-m-i'); if(l)l.addEventListener('click',fazerLogoutIndex);}}
            
            } else { // --- DESLOGADO ---
                if(uNS)uNS.textContent='Fazer Login'; 
                if(uI)uI.src=`https://ui-avatars.com/api/?name=?&b=6b7280&c=fff&bold=true`;
                nPB.href='login.html'; // Link para login
                
                if(cAL){const nA=cAL.cloneNode(true); nA.href='login.html'; nA.innerHTML='<i class="fas fa-sign-in-alt w-6 mr-3"></i> Login'; if(cAL.parentNode)cAL.parentNode.replaceChild(nA,cAL); authLinkSidebar = nA;}
                if(cEL)cEL.style.display='none'; // Esconde Editor
                
                if(cPM){ // Reseta Modal
                    const mUN=cPM.querySelector('p.font-semibold'), mUE=cPM.querySelector('p.text-xs'), mUI=cPM.querySelector('img');
                    if(mUN)mUN.textContent="Nome"; if(mUE)mUE.textContent="email"; if(mUI)mUI.src=`https://ui-avatars.com/api/?name=?&b=6b7280&c=fff&bold=true`;
                    if(cMPL_Top) cMPL_Top.href="login.html"; if(cMPL_Text) cMPL_Text.href="login.html";
                    if(cMLC)cMLC.innerHTML=''; 
                    if(!cPM.classList.contains('hidden')){cPM.classList.add('hidden','opacity-0','scale-95'); cPM.classList.remove('opacity-100','scale-100');}
                }
            }
            userProfileButton = nPB; // Atualiza a referência global
        }

        function fazerLogoutIndex(e){ 
            if(e)e.preventDefault(); 
            localStorage.removeItem('authToken'); localStorage.removeItem('userInfo'); 
            alert('Desconectado.'); 
            const c=()=>{verificarLoginIndex();}; // Chama a atualização da UI
            const m=document.getElementById('profile-modal'); 
            if(m&&!m.classList.contains('hidden')){m.classList.remove('opacity-100','scale-100'); m.classList.add('opacity-0','scale-95');setTimeout(()=>{m.classList.add('hidden');c();},300);}
            else{c();}
        }

        // --- FUNÇÃO escapeHtml ---
        function escapeHtml(unsafe){if(typeof unsafe !== 'string')return "";try{return unsafe.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");}catch(e){return "";}}

        // --- LÓGICA DA BARRA DE BUSCA ---
        async function performSearchIndex() { if(!searchInput||!searchResultsContainer||!searchDropdown)return; const q=searchInput.value.trim(); searchResultsContainer.innerHTML=''; if(q.length<3){searchDropdown.classList.add('hidden');return;} searchDropdown.classList.remove('hidden'); searchResultsContainer.innerHTML='<div class="p-4 ...">Buscando...</div>'; try{const r=await fetch(`http://localhost:3000/api/noticias/pesquisa?q=${encodeURIComponent(q)}`); if(!r.ok)throw new Error(`Falha ${r.status}`); const d=await r.json(); searchResultsContainer.innerHTML=''; if(d.length===0){searchResultsContainer.innerHTML=`<div class="p-4 ...">Nada para "${escapeHtml(q)}".</div>`;}else{d.forEach(n=>{searchResultsContainer.innerHTML+=`<a href="artigo.html?id=${n._id}" class="block..."><div class="...">${escapeHtml(n.titulo)}</div><div class...">${escapeHtml(n.categoria?.toUpperCase()||'G')}</span></div></a>`;});}}catch(e){console.error('Erro:',e); searchResultsContainer.innerHTML=`<div class="p-4 text-red-500">Erro (${escapeHtml(e.message)}).</div>`;}}
        let searchTimeoutIndex;

        // --- LÓGICA DE CARREGAMENTO DAS NOTÍCIAS DO INDEX ---
        async function carregarNoticiasIndex() {
            if(!noticiasContainer||!destaquesContainer){console.error("Containers não encontrados!");return;}
            noticiasContainer.innerHTML='<p class="... text-center">Carregando...</p>'; destaquesContainer.innerHTML=''; const lH=5, lD=2;
            try{
                const r=await fetch(`http://localhost:3000/api/noticias?page=1&limit=${lH}`); if(!r.ok)throw new Error(`Falha ${r.status}`); const dP=await r.json(); const n=dP.noticias||[];
                noticiasContainer.innerHTML=''; destaquesContainer.innerHTML='';
                if(n.length===0){noticiasContainer.innerHTML='<p class="... text-center">Nenhuma notícia.</p>'; if(prevBtn)prevBtn.style.display='none'; if(nextBtn)nextBtn.style.display='none'; return;}
                n.slice(0,lD).forEach(noticia=>{if(!noticia)return; const img=noticia.imagemCapa?`http://localhost:3000/${noticia.imagemCapa.replace(/\\/g,'/')}`:`https://source.unsplash.com/random/1200x400/?news&sig=${noticia._id}`; destaquesContainer.innerHTML+=`<div class="w-full flex-shrink-0 relative"><img src="${img}" alt="${escapeHtml(noticia.titulo||'')}" class="w-full h-64 md:h-96 object-cover brightness-75"><a href="artigo.html?id=${noticia._id}" class="absolute inset-0 group"><div class="absolute bottom-0 p-6 ..."><span class="bg-blue-600 ...">${escapeHtml(noticia.categoria?.toUpperCase()||'G')}</span><h3 class="text-white ... group-hover:underline">${escapeHtml(noticia.titulo||'')}</h3></div></a></div>`;});
                iniciarCarrosselIndex();
                n.slice(0,lH).forEach(noticia=>{noticiasContainer.insertAdjacentHTML('beforeend',renderizarCardNoticiaHomepageIndex(noticia));});
            }catch(e){console.error('Erro:',e); noticiasContainer.innerHTML=`<p class="text-red-500 ... text-center">Erro (${escapeHtml(e.message)}).</p>`; if(prevBtn)prevBtn.style.display='none'; if(nextBtn)nextBtn.style.display='none';}
        }

        // --- RENDERIZAR CARD PARA INDEX ---
        function renderizarCardNoticiaHomepageIndex(noticia){
            if(!noticia)return ""; const img=noticia.imagemCapa?`http://localhost:3000/${noticia.imagemCapa.replace(/\\/g,'/')}`:`https://source.unsplash.com/random/300x200/?news&sig=${noticia._id}`; const rIA=noticia.resumo||"", cB=noticia.conteudo||""; const resumo=(rIA&&!rIA.includes("não")&&!rIA.includes("indis"))?rIA:cB.replace(/<[^>]+>/g,'').substring(0,120)+'...'; let sC='bg-gray-200 dark:bg-gray-600', sD='N/A'; if(noticia.taxaConfiabilidade!==undefined&&noticia.taxaConfiabilidade!==null){ const s=noticia.taxaConfiabilidade; sD=`${s}%`; sC='bg-green-100 dark:bg-green-200 text-green-800 dark:text-green-900'; if(s<85)sC='bg-yellow-100 dark:bg-yellow-200 text-yellow-800 dark:text-yellow-900'; if(s<70)sC='bg-red-100 dark:bg-red-200 text-red-800 dark:text-red-900';} const cat=noticia.categoria?.toUpperCase()||'G'; const data=noticia.dataPublicacao?new Date(noticia.dataPublicacao).toLocaleDateString():'--';
            return `<article class="bg-white dark:bg-slate-800 rounded-lg shadow-md overflow-hidden transition duration-300 hover:-translate-y-1 hover:shadow-xl flex flex-col"><div class="md:flex flex-shrink-0"><div class="md:flex-shrink-0 md:w-48"><img src="${img}" alt="${escapeHtml(noticia.titulo||'')}" class="w-full h-32 md:h-full object-cover"></div><div class="p-4 flex flex-col justify-between flex-grow"><div><div class="flex flex-wrap justify-between items-center text-xs mb-1 gap-1"><span class="bg-purple-100 ...">${escapeHtml(cat)}</span><span class="${sC} font-bold px-2 py-0.5 ... text-xs" title="Confiabilidade"><i class="fas fa-shield-alt mr-1 opacity-75"></i> ${sD}</span><span class="text-gray-500 dark:text-gray-400 ...">${data}</span></div><h3 class="text-lg font-bold ... line-clamp-2"><a href="artigo.html?id=${noticia._id}" class="hover:underline">${escapeHtml(noticia.titulo||'')}</a></h3></div><p class="text-gray-600 dark:text-gray-400 text-sm line-clamp-2 mt-1 flex-grow">${escapeHtml(resumo)}</p><a href="artigo.html?id=${noticia._id}" class="text-blue-600 dark:text-blue-400 hover:underline ... mt-2 self-start">Leia mais <i class="fas fa-arrow-right ml-1 text-xs"></i></a></div></div></article>`;
        }

        // --- LÓGICA DO CARROSSEL ---
        let currentSlideIndex=0; let slidesIndex=[]; let slideIntervalIndex; function goToSlideIndex(i){if(!carousel||slidesIndex.length===0)return; currentSlideIndex=(i+slidesIndex.length)%slidesIndex.length; carousel.style.transform=`translateX(-${currentSlideIndex*100}%)`;} function startSlideIntervalIndex(){clearInterval(slideIntervalIndex); slideIntervalIndex=setInterval(()=>{if(document.hasFocus())goToSlideIndex(currentSlideIndex+1);},5000);} function iniciarCarrosselIndex(){if(!carousel){console.warn("Carrossel não encontrado"); return;} slidesIndex=carousel.querySelectorAll('.flex-shrink-0'); if(slidesIndex.length<=1){if(prevBtn)prevBtn.style.display='none';if(nextBtn)nextBtn.style.display='none'; carousel.style.transform='translateX(0%)';return;}else{if(prevBtn)prevBtn.style.display='block';if(nextBtn)nextBtn.style.display='block';} if(prevBtn){const n=prevBtn.cloneNode(true);prevBtn.parentNode.replaceChild(n,prevBtn); prevBtn=n; prevBtn.addEventListener('click',()=>{goToSlideIndex(currentSlideIndex-1); startSlideIntervalIndex();});} if(nextBtn){const n=nextBtn.cloneNode(true);nextBtn.parentNode.replaceChild(n,nextBtn); nextBtn=n; nextBtn.addEventListener('click',()=>{goToSlideIndex(currentSlideIndex+1); startSlideIntervalIndex();});} startSlideIntervalIndex();}


        // --- FUNÇÃO DE INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            // Define seletores globais AQUI
            menuToggle=document.getElementById('menuToggle'); sidebar=document.getElementById('sidebar'); overlay=document.getElementById('overlay');
            themeToggle=document.getElementById('themeToggle'); themeIcon=document.getElementById('theme-icon'); html=document.querySelector('html');
            searchInput=document.getElementById('searchInput'); searchButton=document.getElementById('searchButton'); searchDropdown=document.getElementById('searchDropdown'); searchResultsContainer=document.getElementById('searchResults');
            noticiasContainer=document.getElementById('ultimas-noticias-container'); destaquesContainer=document.getElementById('highlightCarousel');
            prevBtn=document.getElementById('prevBtn'); nextBtn=document.getElementById('nextBtn'); carousel=document.getElementById('highlightCarousel');
            userProfileButton=document.getElementById('user-profile'); profileModal=document.getElementById('profile-modal');
            authLinkSidebar=document.getElementById('auth-link'); editorLinkSidebar=document.querySelector('nav a[href="editor.html"]');
            modalLogoutContainer=profileModal?profileModal.querySelector('#modal-logout-container'):null;
            modalProfileLink=profileModal?profileModal.querySelector('#modal-profile-link'):null; // Seletor para o link do topo do modal
            modalMyProfileLink=profileModal?profileModal.querySelector('#modal-my-profile-link'):null; // Seletor para o link "Meu Perfil"

            // Adiciona listeners aos elementos encontrados
            if(menuToggle)menuToggle.addEventListener('click',(e)=>{e.stopPropagation();menuOpenIndex?closeMenuIndex():openMenuIndex();});
            if(overlay)overlay.addEventListener('click',closeMenuIndex);
            if(themeToggle)themeToggle.addEventListener('click',toggleThemeIndex); // Corrigido para toggleThemeIndex
            if(searchInput){searchInput.addEventListener('input',()=>{clearTimeout(searchTimeoutIndex);searchTimeoutIndex=setTimeout(performSearchIndex,300);}); searchInput.addEventListener('focus',()=>{if(searchInput.value.length>=3&&searchDropdown)searchDropdown.classList.remove('hidden');}); searchInput.addEventListener('blur',()=>{if(searchDropdown)setTimeout(()=>{searchDropdown.classList.add('hidden');},200);});}
            if(searchButton)searchButton.addEventListener('click',performSearchIndex);
            document.addEventListener('keydown',(e)=>{if(e.key==='Escape'&&menuOpenIndex)closeMenuIndex();});
            document.addEventListener('click',handleClickOutsideModalIndex); // Corrigido para handleClickOutsideModalIndex

            // Chama as funções de inicialização
            carregarTemaIndex();
            verificarLoginIndex(); // <<< Verifica login
            carregarNoticiasIndex(); // <<< Carrega notícias
        });
    </script>
</body>
</html>